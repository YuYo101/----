# 声场复现系统优化修改日志

**日期**: 2026年2月25日
**文件**: Simu_SFR_AUTO.m
**问题**: 反馈循环对负误差（能量过大）调节效果差，尤其在低频段

---

## 一、问题诊断

### 1.1 初步观察
用户反馈：反馈循环对正误差能够有效调节，但对负误差调节效果很差。

### 1.2 初步假设（已排除）
**假设**：增益矩阵Gain的调整算法存在不对称性
**原始逻辑** (Simu_SFR_AUTO.m:160-169)：
```matlab
% 所有通道使用固定0.2dB调整步长
for i = 1:length(Gain(1,:))
    [Gm(1,i),IGm(1,i)] = max(abs(Gain(:,i)));
    for j = 1:NchR
        if Gm(1,i)>2 && j~=IGm(1,i)
            Gain(j,i) = Gain(j,i) + sign(Gain(IGm(1,i),i))*0.2;
        end
    end
end
```

**问题分析**：
- 正误差（能量不足）：所有通道+0.2dB → 多通道相干叠加同向增强 → 效果明显 ✓
- 负误差（能量过大）：所有通道-0.2dB → 相位干涉可能抵消衰减效果 → 效果差 ✗

### 1.3 根本原因定位
**实际根源**：低频的频响矩阵过度正则化

---

## 二、尝试的改进方案（增益调整策略）

### 方案1：非对称调整系数
**提交**: `0db9c00` - 实现方案1：非对称调整系数改进负误差处理

**修改内容** (Simu_SFR_AUTO.m:160-175)：
```matlab
% 方案1：非对称调整系数 - 根据误差符号使用不同的调整幅度
for i = 1:length(Gain(1,:))
    [Gm(1,i),IGm(1,i)] = max(abs(Gain(:,i)));
    for j = 1:NchR
        if Gm(1,i)>2 && j~=IGm(1,i)
            % 根据误差符号使用不同的调整幅度
            if Gain(IGm(1,i),i) > 0
                adjustStep = 0.2;  % 正误差（能量不足）用小步长
            else
                adjustStep = 0.4;  % 负误差（能量过大）用大步长，加强衰减
            end
            Gain(j,i) = Gain(j,i) + sign(Gain(IGm(1,i),i))*adjustStep;
        end
    end
end
```

**原理**：
- 针对负误差收敛慢的问题，使用更大的调整幅度（0.4dB vs 0.2dB）
- 正误差保持小步长避免过冲

**测试结果**：效果不明显

---

### 方案2：选择性通道调整
**提交**: `bcc3ea8` - 实现方案2：选择性通道调整改进负误差处理

**修改内容** (Simu_SFR_AUTO.m:160-176)：
```matlab
% 方案2：选择性通道调整 - 正误差协同增强，负误差选择性衰减
for i = 1:length(Gain(1,:))
    [Gm(1,i),IGm(1,i)] = max(abs(Gain(:,i)));
    for j = 1:NchR
        if Gm(1,i)>2 && j~=IGm(1,i)
            if Gain(IGm(1,i),i) > 0
                % 正误差（能量不足）：所有通道协同增强
                Gain(j,i) = Gain(j,i) + 0.2;
            else
                % 负误差（能量过大）：只减少主通道，其他通道略减或不变
                % 避免所有通道同时衰减导致的相位干涉问题
                Gain(j,i) = Gain(j,i) - 0.05;  % 其他通道仅略微衰减
            end
        end
    end
end
```

**原理**：
- 正误差：所有通道协同增强（+0.2dB）
- 负误差：主通道按Error值大幅衰减，其他通道仅-0.05dB
- 避免所有通道同时大幅衰减造成的多通道相位干涉

**测试结果**：效果不明显

---

## 三、根本解决方案（正则化参数优化）

### 3.1 问题重新分析

**关键发现**：问题出在低频，可能与频响矩阵的正则化有关

#### 频响矩阵处理流程
```matlab
% Step3: SVD分解 (Simu_SFR_AUTO.m:18-64)
HestAll = fft(ir(:,i,:), N, 1);  % 时域脉冲响应 → 频域传递函数
[U_svd, S_svd, V_svd] = svd(G);   % 对每个频点进行SVD分解

% Step4: 正则化参数 (原版本)
lmd0 = 1.0;
s0 = 1/2/lmd0 = 0.5;

% 混合正则化策略
if s(i,nf) >= 1/s0        % s >= 2.0  → lmd = 0 (无正则化)
elseif s(i,nf) > 1/2/s0   % 1.0 < s < 2.0 → lmd = sqrt(s/s0-s^2)
else                       % s <= 1.0 → lmd = 0.5 (强正则化)

% 计算正则化矩阵
L_s(k,k) = s_k / (s_k² + λ²)      % 驱动信号的加权系数
L_Re(k,k) = s_k² / (s_k² + λ²)    % 复现响应的传递系数
```

#### 低频问题的物理根源

**1. 低频奇异值特性**
- 房间模态稀疏 → 传递函数矩阵条件数差
- 低频扬声器效率低 → 传递函数幅值小
- 导致 s(i,nf) 在低频往往 < 1.0

**2. 过度正则化的后果**
```
当 s = 0.05, λ = 0.5 时:
L_Re = s²/(s²+λ²) = 0.0025/0.2525 ≈ 0.01 (仅1%的能量传递！)

当 s = 0.3, λ = 0 时:
L_Re = s²/s² = 1.0 (100%的能量传递)
```

**3. L_Re 的物理意义**
- L_Re 表示该奇异值通道能传递多少能量到目标点
- 当 λ 较大时，L_Re → 0，相当于截断了该通道
- **低频被过度正则化 = 低频通道被人为截断**

**4. 正负误差的对称性失效**
- **正误差（能量不足）**：即使增加Gain，也会被 L_Re ≈ 0.01 限制，复现能量无法增加
- **负误差（能量过大）**：反馈减少Gain时效果也差，因为低频本身就被抑制了

### 3.2 方案A：频率依赖的正则化参数

**提交**: `512e0f9` - 实现方案A：频率依赖的正则化参数改进低频处理

**修改内容** (Simu_SFR_AUTO.m:66-116)：
```matlab
%% Step4 正则化参数
lmd0_base=1;  % 基准正则化参数
lmd = zeros(N, min(NchS,NchR));
L_s=zeros(N,NchS,NchR);
L_Re=zeros(N,NchR,NchR);
s=zeros(min(NchS,NchR),N);

% 方案A: 频率依赖的正则化参数（保持共轭对称性）
for nf=1:N
    % 计算当前频点对应的实际频率 (Hz)
    if nf <= floor(N/2)+1
        % 正频率部分: 0 到 Fs/2
        freq = (nf-1) * Fs / N;
    else
        % 负频率部分: 使用镜像点的频率（保证对称）
        mirror_nf = N - nf + 2;
        freq = (mirror_nf-1) * Fs / N;
    end

    % 根据频率调整正则化参数
    if freq < 100  % 100Hz以下，强烈放松正则化
        lmd0 = 0.1;  % 降低10倍
    elseif freq < 300  % 100-300Hz，中度放松
        lmd0 = 0.3;  % 降低约3倍
    elseif freq < 500  % 300-500Hz，轻度放松
        lmd0 = 0.6;
    else  % 500Hz以上，保持原值
        lmd0 = lmd0_base;
    end

    % 混合正则化参数计算
    s0=1/2/lmd0;
    s(:,nf) = diag(squeeze(S_svd(nf,:,:)));

    for i=1:min(NchS,NchR)
        if s(i,nf)>=1/s0
            lmd(nf,i)=0;
        elseif s(i,nf)>1/2/s0
            lmd(nf,i)=sqrt(s(i,nf)/s0-s(i,nf)^2);
        else
            lmd(nf,i)=1/2/s0;
        end
    end

    for k=1:min(NchS,NchR) %%奇异值矩阵
        L_s(nf,k,k)=S_svd(nf,k,k)/(S_svd(nf,k,k)^2+lmd(nf,k)^2);
        L_Re(nf,k,k)=S_svd(nf,k,k)^2/(S_svd(nf,k,k)^2+lmd(nf,k)^2);
    end
end
```

**核心改进点**：

1. **频率分段正则化策略**
   | 频率范围 | 正则化参数 λ₀ | 相对原值 | 物理意义 |
   |---------|--------------|---------|---------|
   | 0-100Hz | 0.1 | 降低10倍 | 强烈放松，允许低频能量传递 |
   | 100-300Hz | 0.3 | 降低3.3倍 | 中度放松，中低频过渡 |
   | 300-500Hz | 0.6 | 降低1.7倍 | 轻度放松 |
   | >500Hz | 1.0 | 保持不变 | 中高频保持原有严格正则化 |

2. **保持FFT共轭对称性**
   ```matlab
   if nf <= floor(N/2)+1
       freq = (nf-1) * Fs / N;  % 正频率：0 到 Fs/2
   else
       mirror_nf = N - nf + 2;   % 负频率使用镜像点
       freq = (mirror_nf-1) * Fs / N;
   end
   ```
   - 实信号FFT结果必须保持共轭对称
   - 负频率部分使用与正频率相同的正则化参数
   - 确保IFFT后仍为实信号（无虚部）

**理论效果分析**：

对于低频小奇异值（例如 s = 0.05）：

| 方案 | λ | L_Re 计算 | L_Re 值 | 能量传递率 |
|-----|---|----------|---------|-----------|
| **原方案** | 0.5 | 0.0025/(0.0025+0.25) | 0.01 | 1% |
| **新方案(<100Hz)** | 0.05 | 0.0025/(0.0025+0.0025) | 0.50 | 50% |

**改进幅度：50倍！**

---

## 四、修改总结

### 4.1 Git提交历史

```
512e0f9 - 实现方案A：频率依赖的正则化参数改进低频处理 [最终方案]
bcc3ea8 - 实现方案2：选择性通道调整改进负误差处理 [已废弃]
0db9c00 - 实现方案1：非对称调整系数改进负误差处理 [已废弃]
b628256 - 保存当前工作状态 [基线版本]
```

### 4.2 代码结构变化

| 修改位置 | 原行数 | 新行数 | 变更类型 |
|---------|-------|-------|---------|
| Step4 正则化参数 | 66-92 | 66-116 | 重构+扩展 |
| Step7 反馈循环增益调整 | 160-169 | 160-176 | 优化（后被废弃）|

### 4.3 参数变更对比

| 参数 | 原值 | 新值（频率依赖）| 影响范围 |
|-----|------|----------------|---------|
| lmd0 | 1.0（固定）| 0.1~1.0（分段）| 所有频点 |
| s0 | 0.5（固定）| 0.5~5.0（分段）| 奇异值阈值 |

---

## 五、预期效果与验证

### 5.1 预期改进

1. **低频能量传递增强**
   - <100Hz: L_Re 从 1% 提升到 50%（理论值）
   - 低频复现能力显著提升

2. **正负误差对称性恢复**
   - 正误差：反馈循环能有效增加低频能量
   - 负误差：反馈循环能有效减少低频能量

3. **中高频稳定性保持**
   - >500Hz 保持原有正则化强度
   - 防止高频噪声放大

### 5.2 验证方法

1. **查看误差曲线**
   - 运行代码后检查 `Error.mat` 和 `Error1.mat` ~ `Error5.mat`
   - 对比反馈前后低频（20-100Hz）的误差变化

2. **检查信号实数性**
   ```matlab
   % 检查IFFT后是否有虚部
   max(abs(imag(eest)))  % 应该接近0（<1e-10）
   max(abs(imag(eest_FB)))
   ```

3. **可视化分析**
   ```matlab
   % 绘制L_Re随频率的变化
   L_Re_mean = squeeze(mean(L_Re(:,:,:), [2,3]));
   freqVector = (0:N-1) * Fs / N;
   plot(freqVector(1:N/2), L_Re_mean(1:N/2))
   xlabel('频率 (Hz)'), ylabel('L_{Re} (能量传递系数)')
   ```

---

## 六、关键代码原理说明

### 6.1 SVD正则化逆矩阵
```matlab
% 传递函数矩阵: G = U * S * V'  (NchR × NchS)
% Tikhonov正则化伪逆: G_inv = V * L_s * U'

其中：
L_s(k,k) = s_k / (s_k² + λ_k²)   % 驱动信号加权
L_Re(k,k) = s_k² / (s_k² + λ_k²) % 复现响应传递系数
```

**物理意义**：
- s_k: 第k个奇异值，代表该通道的传递增益
- λ_k: 正则化参数，抑制小奇异值以提高数值稳定性
- L_Re: 该通道实际能传递到目标点的能量比例

### 6.2 频率依赖正则化的数学基础

**基本矛盾**：
- 大 λ → 数值稳定 ↑，但低频能量 ↓
- 小 λ → 低频能量 ↑，但数值不稳定 ↑

**解决方案**：
- 低频：奇异值小但物理需求高 → 用小 λ（容忍一定不稳定性）
- 高频：奇异值通常较大 → 用大 λ（保持严格正则化）

### 6.3 共轭对称性保持原理

对于长度为 N 的实信号 x(t)，其FFT X(f) 满足：
```
X[k] = conj(X[N-k])  (k = 1, 2, ..., N-1)
X[0] 和 X[N/2] 必须是实数
```

在频域处理时，必须保证：
```matlab
lmd(nf, :) = lmd(N-nf+2, :)  % 正负频率使用相同参数
```

否则 IFFT 后会产生虚部，破坏实信号性质。

---

## 七、未来优化方向

### 7.1 自适应正则化参数
- 根据实际测量的奇异值分布自动调整 λ
- 引入基于信噪比的动态正则化

### 7.2 频率-空间联合优化
- 考虑不同接收点对不同频率的敏感度差异
- 实现基于感知加权的正则化

### 7.3 迭代正则化
- 在反馈循环中动态调整 λ
- 根据误差收敛情况自适应放松或加强正则化

---

## 八、参考资料

### 8.1 相关文献
- Kirkeby, O., & Nelson, P. A. (1999). Digital filter design for inversion problems in sound reproduction. *Journal of the Audio Engineering Society*.
- Spors, S., & Rabenstein, R. (2008). Spatial aliasing artifacts produced by linear and circular loudspeaker arrays. *IEEE Transactions on Audio, Speech, and Language Processing*.

### 8.2 数学基础
- Tikhonov正则化: Hansen, P. C. (2010). *Discrete Inverse Problems: Insight and Algorithms*.
- SVD分解: Golub, G. H., & Van Loan, C. F. (2013). *Matrix Computations*.

---

**文档生成时间**: 2026-02-25 17:15:00
**最后更新**: commit 512e0f9
**仓库地址**: https://github.com/YuYo101/----.git
